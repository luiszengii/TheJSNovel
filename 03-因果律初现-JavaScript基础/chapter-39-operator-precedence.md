《第39次记录:运算符优先级事故 —— 表达式求值的顺序规则》

---

## 事故现场

周三下午三点，你盯着商品价格管理后台的计算结果，眉头越皱越紧。

促销活动明天上线，运营部的消息一条接一条弹出来："价格系统测试完了吗？""客户在等最终报价。""活动页面今晚必须发布。"你一一回复"马上好"，但心里却没底。

页面上的数字让你困惑不已。你设计的定价公式很简单：基础价格加上配送费,再乘以折扣。100元商品加10元配送，打8折，应该是`(100+10)*0.8=88元`才对。但系统显示的价格是`108元`。

"怎么可能..."你喃喃道，手指在键盘上敲出计算代码：`const price = 100 + 10 * 0.8`。你在本地控制台测试了一遍，输出`108`。

你以为眼花了，揉了揉眼睛再看。确实是`108`。你改成另一个商品：`50 + 20 * 0.8`，输出`66`。应该是`(50+20)*0.8=56`，又错了！

窗外的天色渐暗，办公室的人陆续下班。你的同事路过时看了一眼你的代码，皱了皱眉："这个表达式...运算顺序对吗？"

"运算顺序？"你愣了一下。你以为JavaScript会从左到右计算，但显然不是这样。

电脑右下角弹出QA的消息："价格测试全部不对，能解释一下吗？"附带了一个长长的错误报告列表。你的手心开始冒汗。

---

## 深入迷雾

你创建了一个测试文件，决心搞清楚这些表达式到底是怎么计算的。首先测试最基础的算术运算：

```javascript
console.log(10 + 5 * 2)  // 期望: (10+5)*2 = 30
// 实际输出: 20
```

不是30，是20。你突然意识到什么："乘法先算？"你想起高中数学里的"先乘除，后加减"。JavaScript也遵循这个规则吗？

你试着加上括号：

```javascript
console.log((10 + 5) * 2)  // 30
```

这次是30了！"所以JavaScript遵循数学运算规则。"你松了口气，但新的问题随之而来——其他运算符呢？

你测试了逻辑运算符：

```javascript
console.log(true || false && false)
```

输出`true`。如果从左到右算，应该是`(true || false) && false = false`。但实际是`true || (false && false) = true`。"&&比||优先？"你写下笔记。

你想起还有比较运算符：

```javascript
console.log(5 > 3 && 10 > 8)  // true
console.log(5 > 3 && 10)  // 10
```

第一个返回`true`，说明先计算了`5 > 3`和`10 > 8`，再进行`&&`运算。比较运算优先于逻辑运算。

你测试自增运算符：

```javascript
let x = 5
console.log(x++ + ++x)
```

停顿了三秒，脑海里模拟执行过程："x++先用后加，返回5，x变成6。然后++x先加后用，x变成7，返回7。所以`5 + 7 = 12`。"

你运行代码，输出`12`。"对了！"你兴奋地一拍桌子。

但还有赋值运算：

```javascript
let a, b, c
a = b = c = 5
console.log(a, b, c)  // 5 5 5
```

全都是5。"赋值是从右到左的。"你又写下一条笔记。

你靠在椅背上，整理思路。JavaScript的运算符有一套完整的优先级体系：括号最高，然后是自增自减，然后乘除，然后加减，然后比较，然后逻辑，最后是赋值。

你想起那个定价bug，问题就在这里——你没用括号，JavaScript按照它的规则先算了`10 * 0.8 = 8`，再算`100 + 8 = 108`。

---

## 真相浮现

你整理了运算符优先级的核心规则。

**问题代码:运算顺序错误**

```javascript
// 错误:期望(100+10)*0.8
const price = 100 + 10 * 0.8  // 108

// 正确:用括号明确顺序
const price = (100 + 10) * 0.8  // 88
```

**优先级层级**

```javascript
// 括号最高
(10 + 5) * 2  // 30

// * / % 高于 + -
10 + 5 * 2  // 20 (先算5*2)
10 - 6 / 2  // 7 (先算6/2)

// 比较高于逻辑
5 > 3 && 10 > 8  // true (先比较,再&&)

// && 高于 ||
true || false && false  // true (先算&&)
```

**结合性规则**

```javascript
// 左结合:从左到右
10 - 5 - 2  // (10-5)-2 = 3

// 右结合:从右到左
let a, b, c
a = b = c = 5  // 从右往左赋值
```

你把定价系统的代码改成了这样：

```javascript
function calculatePrice(basePrice, shippingFee, discount) {
    return (basePrice + shippingFee) * discount
}

const finalPrice = calculatePrice(100, 10, 0.8)
console.log(finalPrice)  // 88
```

重新测试，所有价格都对了。

---

## 世界法则

**世界规则 1:优先级层级**

```javascript
// 从高到低:
// () > ++ -- > * / % > + - > > < >= <= > == === > && > ||

10 + 5 * 2  // 20
5 > 3 && 10 > 8  // true
true || false && false  // true
```

**世界规则 2:括号强制优先**

```javascript
(10 + 5) * 2  // 30
(true || false) && false  // false

// 推荐:用括号明确意图
(a + b) * c  // 清晰
```

**世界规则 3:结合性**

```javascript
// 左结合(从左到右)
10 - 5 - 2  // (10-5)-2 = 3

// 右结合(从右到左)
a = b = c = 5  // a=(b=(c=5))
```

**世界规则 4:自增自减位置**

```javascript
let x = 5

++x  // 先加后用,返回6
x++  // 先用后加,返回5(但x变6)
```

**世界规则 5:短路求值**

```javascript
// || : 左为真,不求右
true || expensiveFunction()  // 不执行函数

// && : 左为假,不求右
false && expensiveFunction()  // 不执行函数
```

---

**事故档案编号**:JS-2024-1639
**影响范围**:表达式求值、价格计算、逻辑判断
**根本原因**:不理解运算符优先级和结合性
**修复成本**:低(使用括号明确顺序)

这是JavaScript世界第39次被记录的运算符优先级事故。运算符有严格的优先级层级——括号最高,算术运算高于比较,比较高于逻辑,赋值最低。结合性决定了相同优先级的计算顺序。理解优先级,就理解了JavaScript如何解析和求值复杂表达式。当不确定时,用括号明确意图。
